import paramiko
import pandas as pd
import os
from datetime import datetime
import openpyxl

# --- Functions without Alteryx dependencies ---

def download_file_from_sftp_to_network(output_network_path):
    """
    Downloads a single file from an SFTP server to a specified network directory.

    Args:
        output_network_path (str): The full network path where the file should be saved.
                                   Example: r'\\\\netapp\\depts\\Jannat\\Viaero\\01. Quickbase'
    """
    print("Starting SFTP file download...")
    try:
        # SFTP connection parameters
        host = 'ftp.onevizion.com'
        username = 'xxx'  # Replace with your username
        password = 'xxx'  # Replace with your password

        # Remote file path and name
        remote_file_path = '/home/samsung_sea2/es/Outbound/Quote_Tracker/Customer_PO_Doc'
        remote_file_name = 'CUST_PO_DOC_.xlsx'
        full_remote_path = os.path.join(remote_file_path, remote_file_name)

        # Local download directory and file name on the network drive
        current_datetime = datetime.now().strftime("%Y%m%d_%H%M%S")
        local_file_name = f"CUST_PO_DOC_{current_datetime}.xlsx"
        full_local_path = os.path.join(output_network_path, local_file_name)
        
        # Ensure the network directory exists
        os.makedirs(output_network_path, exist_ok=True)

        # Establish SFTP connection
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(host, username=username, password=password)

        sftp = ssh.open_sftp()

        # Download file
        sftp.get(full_remote_path, full_local_path)
        print(f"File downloaded successfully to {full_local_path}")
        
        return full_local_path

    except Exception as e:
        print(f"An error occurred: {e}")
        return None
    finally:
        # Close SFTP and SSH connections safely
        if 'sftp' in locals():
            sftp.close()
        if 'ssh' in locals():
            ssh.close()


def process_excel_to_dataframe(excel_path):
    """
    Reads an Excel file and returns its content as a DataFrame.
    """
    print(f"Attempting to process Excel file from: {excel_path}")
    try:
        if excel_path and os.path.exists(excel_path):
            df = pd.read_excel(excel_path)
            print("Successfully processed Excel file.")
            return df
    except Exception as e:
        print(f"Error processing the Excel data: {e}")
        return pd.DataFrame()


# --- Standalone Python Script Execution ---

# Note the 'r' prefix for a raw string to avoid invalid escape sequence warnings
# You can also use double backslashes: '\\\\netapp\\depts\\Jannat\\Viaero\\01. Quickbase'
network_path = r'\\netapp\depts\Jannat\Viaero\01. Quickbase'

# Download the file to the network path
downloaded_file_path = download_file_from_sftp_to_network(network_path)

# If the download was successful, process the Excel file
if downloaded_file_path:
    processed_df = process_excel_to_dataframe(downloaded_file_path)
    
    # You can now work with the pandas DataFrame
    print("\n--- Processed DataFrame ---")
    print(processed_df.head())
